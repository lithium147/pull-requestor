<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="Default Maven PMD Plugin Ruleset"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 http://pmd.sourceforge.net/ruleset_2_0_0.xsd">

    <description>
        Follows exclusion approach:
        - start by including all the standard rules
        - then exclude rules one by one as required
        This means new rules will automatically be included.

        The master list of rules is here: https://pmd.github.io/pmd/pmd_rules_java.html
    </description>

    <rule ref="category/java/bestpractices.xml">
        <exclude name="GuardLogStatement"/>
        <exclude name="AvoidReassigningParameters"/>
        <exclude name="UnitTestAssertionsShouldIncludeMessage"/>
        <exclude name="UnusedFormalParameter"/>             <!-- Covered by sonar -->
        <exclude name="AvoidStringBufferField"/>            <!-- Doesn't make sense -->
    </rule>
    <rule ref="category/java/bestpractices.xml/UnitTestShouldIncludeAssert">
        <!-- support WebTestClient,MockMvc,PAssert (beam) -->
        <properties>
            <property name="extraAssertMethodNames"
                      value="expectHeader,expectCookie,expectStatus,expectBody,expectAll,expectBodyList,andExpect,countAsserts"/>
        </properties>
    </rule>
    <rule ref="category/java/bestpractices.xml/UnitTestContainsTooManyAsserts">
        <properties>
            <property name="maximumAsserts" value="10"/>    <!-- default is 1 -->
        </properties>
    </rule>
    <rule ref="category/java/bestpractices.xml/LooseCoupling">
        <!-- GenericJson is used by many of the Google apis -->
        <properties>
            <property name="allowedTypes" value="java.util.Properties,com.google.api.client.json.GenericJson,org.springframework.http.HttpHeaders" />
        </properties>
    </rule>

    <rule ref="category/java/codestyle.xml">
        <exclude name="TooManyStaticImports"/>
        <exclude name="LocalVariableCouldBeFinal"/>
        <exclude name="MethodArgumentCouldBeFinal"/>
        <exclude name="AtLeastOneConstructor"/>
        <exclude name="ShortClassName"/>                    <!-- Avoid short class names like Main -->
        <exclude name="GenericsNaming"/>                    <!-- only allows for single char -->
        <exclude name="OnlyOneReturn"/>
        <exclude name="ShortVariable"/>
        <exclude name="ShortMethodName"/>
        <exclude name="CallSuperInConstructor"/>
        <exclude name="UseUnderscoresInNumericLiterals"/>   <!-- doesn't make sense for date numbers: 20230303 -->
    </rule>
    <rule ref="category/java/codestyle.xml/FieldNamingConventions">
        <priority>3</priority>  <!-- default is 1 - unfortunately sonar doesn't respect this -->
        <properties>
            <!-- Relax the constant naming convention to allow any case -->
            <property name="constantPattern" value="[a-zA-Z0-9_]*"/>
        </properties>
    </rule>
    <rule ref="category/java/codestyle.xml/ClassNamingConventions">
        <properties>
            <!-- Default pattern doesn't allow for IT classes -->
            <property name="testClassPattern"
                      value="^(Test|IT).*$|^[A-Z][a-zA-Z0-9]*Test(s|Case)?$|^[A-Z][a-zA-Z0-9]*IT(Case)?$"/>
        </properties>
    </rule>
    <rule ref="category/java/codestyle.xml/ControlStatementBraces">
        <properties>
            <property name="checkSingleIfStmt" value="false"/> <!-- allow single line if -->
        </properties>
    </rule>
    <rule ref="category/java/codestyle.xml/LongVariable">
        <properties>
            <property name="minimum" value="34"/>           <!-- default is 17 -->
        </properties>
    </rule>
    <rule ref="category/java/codestyle.xml/LinguisticNaming">
        <properties>
            <property name="ignoredAnnotations" value="java.lang.Override,org.junit.jupiter.api.Test"/>
        </properties>
    </rule>
    <rule ref="category/java/codestyle.xml/CommentDefaultAccessModifier">
        <properties>
            <!-- Ignore @Nested -->
            <property name="ignoredAnnotations"
                      value="android.support.annotation.VisibleForTesting,co.elastic.clients.util.VisibleForTesting,com.google.common.annotations.VisibleForTesting,org.junit.jupiter.api.AfterAll,org.junit.jupiter.api.AfterEach,org.junit.jupiter.api.BeforeAll,org.junit.jupiter.api.BeforeEach,org.junit.jupiter.params.ParameterizedTest,junit.extensions.RepeatedTest,org.junit.jupiter.api.Test,org.junit.jupiter.api.TestFactory,org.junit.jupiter.api.TestTemplate,org.junit.jupiter.api.extension.RegisterExtension,org.junit.jupiter.api.Nested,com.intuit.karate.junit5.Karate.Test,com.intuit.karate.junit5.Karate"/>
            <!-- ignore test related methods -->
            <!-- TODO ignore constructors of test classes -->
            <property name="regex" value="\/\*\s*(default|package)\s*\*\/"/>
        </properties>
    </rule>

    <rule ref="category/java/design.xml">
        <exclude name="ClassWithOnlyPrivateConstructorsShouldBeFinal"/>
        <exclude name="UseObjectForClearerAPI"/>
        <exclude name="AvoidUncheckedExceptionsInSignatures"/>
        <exclude name="LoosePackageCoupling"/>              <!-- must be customized to be useful -->
        <exclude name="UseUtilityClass"/>                   <!-- false positive on Application class -->
        <exclude name="AvoidCatchingGenericException"/>     <!-- what's wrong with catching RuntimeException? -->
        <exclude name="FinalFieldCouldBeStatic"/>           <!-- Ok for prod but not for test -->
        <exclude name="AbstractClassWithoutAnyMethod"/>     <!-- Doesn't recognise abstract classes that implement an interface -->
    </rule>
    <rule ref="category/java/design.xml/LawOfDemeter">
        <properties>
            <property name="trustRadius" value="2"/>        <!-- default 1 -->
        </properties>
    </rule>
    <rule ref="category/java/design.xml/ExcessiveImports">
        <properties>
            <property name="minimum" value="90"/>           <!-- default 30 -->
        </properties>
    </rule>
    <rule ref="category/java/design.xml/TooManyMethods">
        <properties>
            <property name="maxmethods" value="30"/>        <!-- default 10 -->
        </properties>
    </rule>
    <rule ref="category/java/design.xml/TooManyFields">
        <properties>
            <!-- TODO allow more fields for tests -->
            <property name="maxfields" value="20"/>         <!-- default 15 -->
        </properties>
    </rule>
    <rule ref="category/java/design.xml/SignatureDeclareThrowsException">
        <properties>
            <!-- mockMvc throws Exception, so ignore all test methods -->
            <property name="IgnoreJUnitCompletely" value="true"/>
        </properties>
    </rule>

    <rule ref="category/java/errorprone.xml">
        <exclude name="UseLocaleWithCaseConversions"/>
        <exclude name="NullAssignment"/>
        <exclude name="AvoidLiteralsInIfCondition"/>
        <exclude name="TestClassWithoutTestCases"/>
        <exclude name="AvoidDuplicateLiterals"/>            <!-- Ok for prod but not for test -->
        <exclude name="AvoidCatchingThrowable"/>            <!-- already reported by sonar -->
        <exclude name="AvoidFieldNameMatchingMethodName"/>  <!-- not compatible with fluent coding style -->
        <exclude name="AvoidFieldNameMatchingTypeName"/>    <!-- covered by sonar -->
    </rule>

    <rule ref="category/java/multithreading.xml">
        <exclude name="UseConcurrentHashMap"/>
        <exclude name="DoNotUseThreads"/>
    </rule>

    <rule ref="category/java/performance.xml">
        <exclude name="AvoidInstantiatingObjectsInLoops"/>  <!-- too imprecise to be useful -->
    </rule>

    <!-- Non-java rules -->
    <rule ref="category/html/bestpractices.xml">
    </rule>
    <rule ref="category/xml/bestpractices.xml">
    </rule>
    <rule ref="category/xml/errorprone.xml">
    </rule>
    <rule ref="category/plsql/bestpractices.xml">
    </rule>
    <rule ref="category/plsql/codestyle.xml">
    </rule>
    <rule ref="category/plsql/codestyle.xml/LineLength">
        <properties>
            <property name="maxLineLength" value="120" />   <!-- default 80, 120 is inline with other tools -->
        </properties>
    </rule>
    <rule ref="category/plsql/design.xml">
    </rule>
    <rule ref="category/plsql/errorprone.xml">
    </rule>
    <rule ref="category/pom/errorprone.xml">
    </rule>
    <rule ref="category/ecmascript/bestpractices.xml">
        <exclude name="UseBaseWithParseInt"/>               <!-- parseInt("12") seems clear to me -->
        <exclude name="GlobalVariable"/>                    <!-- Too many false positives -->
    </rule>
    <rule ref="category/ecmascript/codestyle.xml">
        <exclude name="IfStmtsMustUseBraces"/>              <!-- doesn't cater for single line if -->
        <exclude name="NoElseReturn"/>                      <!-- debatable -->
    </rule>
    <rule ref="category/ecmascript/errorprone.xml">
    </rule>
</ruleset>
